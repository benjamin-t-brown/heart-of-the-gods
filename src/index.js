function e(e){function t(t){let s=me(e);if(s===t)return;let r=s.get(R),i=s.get(T),a=t.get(T);for(let{r:e,offset:s}of r.hitCircles){let[r,n]=qe(i.angle,s),{x:l,y:o}=i,[h,c]=qe(a.angle,0),{x:d,y:g}=a;if($e([l+r,o+n,e],[d+h,g+c,10]))return t.get(_).hp=0,void Xe("col")}}function s(e,t){let s=e.get(R),r=e.get(T),i=e.get(A),a=t.get(C),n=t.get(P),l=t.get(T);if(!(pe(e)&&"player"===n.allegiance||!pe(e)&&"enemy"===n.allegiance))for(let{r:o,offset:h}of s.hitCircles){let[s,c]=qe(r.angle,h),{x:d,y:g}=r;if($e([d+s,g+c,o],[l.x,l.y,a.circle.r]))return ke(t),i.sprTimer.start(),e.get(_).hp-=n.dmg,void Xe("hit1")}}function r(e,t){let s=e.get(R),r=e.get(T),i=t.get(v);for(let{r:e,offset:t}of s.hitCircles){let[s,a]=qe(r.angle,t),{x:n,y:l,w:o,h:h}=i.rect,c=r.x+s,d=r.y+a,g=n+o/2,p=l+h/2;if($e([c,d,e],[g,p,(o+16)/2])){let e=Ke([g,p],[c,d]),[t,s]=qe(e,1);r.x+=3*t,r.y+=3*s}}}function i(e,t){let s=e.get(T),r=e.get(A),i=t.get(C),a=t.get(C),n=t.get(P),l=t.get(T);if("enemy"===n.allegiance)return;let{x:o,y:h}=s;return $e([o,h,i.circle.r],[l.x,l.y,a.circle.r])?(ke(t),r.sprTimer.start(),e.get(_).hp-=n.dmg,void Xe("hit2")):void 0}function a(t){let s=me(e),r=s.get(R),i=s.get(F),a=s.get(T),n=t.get(C),l=t.get(T);for(let{r:e,offset:s}of r.hitCircles){let[r,o]=qe(a.angle,s),{x:h,y:c}=a;if($e([h+r,c+o,e],[l.x,l.y,n.circle.r]))return ke(t),i.crates++,void Xe("crate")}}function n(t){let s=me(e),r=s.get(R),i=s.get(T),a=s.get(A),n=t.get(C),l=t.get(T),o=t.get(U);if(o.hitTimer.isComplete())for(let{r:e,offset:t}of r.hitCircles){let[r,h]=qe(i.angle,t),{x:c,y:d}=i;if($e([c+r,d+h,e],[l.x,l.y,n.circle.r]))return o.hitTimer.start(),a.sprTimer.start(),s.get(_).hp-=3,void Xe("hit1")}}function l(e,t){let s=e.get(T),r=e.get(A),i=e.get(C),a=t.get(C),n=t.get(P),l=t.get(T);if("enemy"===n.allegiance)return;let{x:o,y:h}=s;return $e([o,h,i.circle.r],[l.x,l.y,a.circle.r])?(ke(t),r.sprTimer.start(),e.get(_).hp-=n.dmg,void Xe("hit2")):void 0}let o=e.select(R,T,A,_),h=e.select(v,T),c=e.select(C,T,P),d=e.select(C,T,A,_),g=e.select(C,T,M),p=e.select(C,T,U),m=e=>{h.iterate(r.bind(this,e)),c.iterate(s.bind(this,e))},u=e=>{c.iterate(i.bind(this,e))},w=e=>{c.iterate(l.bind(this,e))};this.update=()=>{o.iterate(m),o.iterate(t),d.iterate(u),g.iterate(a),p.iterate(n),p.iterate(w)}}function t(e){let t=e.select(F,T,_),s=[],r=[];window.addEventListener("keydown",(e=>{s.push(e)})),window.addEventListener("keyup",(e=>{r.push(e)}));let i=0;x.bind(this)(t,(t=>{let a=t.get(F),n=t.get(T),l=t.get(_);s.forEach((s=>{a.gameStarted?a.gameOver||function(t,s,r,i){let a=xe(e).get(I),n=s.crates,l=e=>n<e?(a.setText(`Not enough supplies (need ${e}).`),!1):(s.crates-=e,!0);"1"===t?l(a.costUpgrade)?r.upgradeTurret()?(a.costUpgrade++,Xe("upgrade"),a.setText("Turret upgraded!"),a.setTextFlash(0,"#71AA34")):(s.crates+=a.costUpgrade,a.setText("No more upgrades available!"),Xe("invalid"),a.setTextFlash(0,"#E1534A")):(Xe("invalid"),a.setTextFlash(0,"#E1534A")):"2"===t?l(a.costNew)?(r.addTurret(),a.costNew+=2,Xe("create"),a.setText("Turret added!"),a.setTextFlash(0,"#71AA34")):(Xe("invalid"),a.setTextFlash(1,"#E1534A")):"3"===t&&(l(a.costHeal)?(Xe("heal"),a.costHeal+=5,a.setText("Ship repaired!"),i.hp+=10,i.hp>i.maxHp&&(i.hp=i.maxHp),a.setTextFlash(0,"#71AA34")):(Xe("invalid"),a.setTextFlash(2,"#E1534A")))}(s.key,a,t.get(R),l):a.firstScreenUiVisible?(a.firstScreenUiVisible=!1,a.gameStarted=!0,xe(e).get(I).setText("Destroy the Hearts of the Gods!"),Xe("start")):(Xe("hit1"),a.firstScreenUiVisible=!0),a.setKeyDown(s.key)})),r.forEach((e=>{a.setKeyUp(e.key)})),y(e)&&((t,s,r,a,n)=>{if(r.hp<=0||we(e).get(_).hp<=0)return;let l=!1,o=!1,h=t.keys;(h.ArrowLeft||h.a)&&s.turn("l"),(h.ArrowRight||h.d)&&s.turn("r"),(h.ArrowUp||h.w)&&(l=!0),h.Shift?(n.enabled=!0,l=!0):n.enabled=!1,l||!h.ArrowDown&&!h.s||(o=!0),s.acc=l,s.accRev=o,(l||o)&&a.spawnTimer.isComplete()&&(i%2&&Xe(n.enabled&&!n.onCooldown?"exh2":"exh"),i++)})(a,n,l,t.get(N),t.get(D)),r.length&&(r=[]),s.length&&(s=[])}))}function s(e){let t=e.select(S),s=e.select(S,b),r=e=>{let t=e.get(S);t.timer.isComplete()&&(t.cb(),ke(e))},i=e=>{let t=e.get(S),s=e.get(b);s.opacity=f(t.timer.getPctComplete(),0,1,t.opacity.start,t.opacity.end),s.scale=f(t.timer.getPctComplete(),0,1,t.scale.start,t.scale.end)};this.update=()=>{t.iterate(r),s.iterate(i)}}function r(e){let t=e.select(N,T);x.bind(this)(t,(t=>{let s=t.get(N),r=t.get(T);if(s.spawnTimer.isComplete()&&(r.acc||r.accRev)){let[t,i]=qe(r.angle,.8*-s.r);((e,t,s,r)=>{let i=new T(t,s),a=e.create();a.add(new b({circle:{r:7,color:r},z:9}),i,new S({duration:700,opacity:{start:.5,end:0},scale:{start:1,end:4}})),He.addRenderObject(a)})(e,r.x+t,r.y+i,s.c),s.spawnTimer.start()}}))}function i(e){let t=(t,s,r,i,a)=>{let n=Ye(t,s),l=Ye(0,270)+180+45,[o,h]=qe(l,n);"ship"===i?((e,t,s,r)=>{let i={1:{sprites:[3,3],turrets:[{sprNum:22,ms:1e3,dmg:1,offset:0,range:300}],hp:1,spriteR:8},2:{sprites:[3,3,3],turrets:[{sprNum:22,ms:1e3,dmg:1,offset:0,range:300},{sprNum:22,ms:900,dmg:1,offset:0,range:400}],hp:10,spriteR:8},3:{sprites:[3,3,3],turrets:[{sprNum:24,ms:700,dmg:2,offset:0,range:350}],hp:15,spriteR:8},4:{sprites:[3,3,3,3],turrets:[{sprNum:24,ms:700,dmg:2,offset:0,range:400},{sprNum:24,ms:700,dmg:2,offset:0,range:400}],hp:20,spriteR:8}}[r],a=new R(i.sprites,i.turrets.map((e=>new E({...e,prjColor:"#F47E1B",prjSpd:10,prjSz:5}))),i.spriteR??8),n=new T(t,s),l=new b({ship:a,scale:2,z:10}),o=e.create();o.add(a,l,n,new N(16),new A,new _(i.hp),new S({duration:6e4,scale:{start:2,end:2}}),new O),He.addRenderObject(o)})(e,2048+o,2048+h,a):"ghost"===i&&((e,t,s)=>{let r=new T(t,s),i=new b({spriteName:"spr_20",scale:4,z:10,useHeading:!1});r.accRate=.5,r.angleRate=5;let a=e.create();a.add(i,r,new A,new _(15),new C(We(0,0,28)),new O,new U),He.addRenderObject(a)})(e,Math.random()>.5?-100:4196,2048+h),r.numEnemies++};this.update=()=>{let s=me(e).get(F);if(s.gameOver)return;let r=(e=>e.get(ye))(e),i=r.get(k);if(y(e)){if(i.ghostTimer.isComplete())if(s.score>=3){for(let e=0;e<i.ghostNumber;e++)t(4096,6144,i,"ghost");i.ghostTimer.start(),i.ghostNumber++}else i.ghostTimer.start();if(i.waveTimer.isComplete())i.numEnemies%10==0&&(i.waveNumber++,i.waveNumber>4&&(i.waveNumber=4,i.waveMin++,i.waveMin>4&&(i.waveMin=4))),t(4096,6144,i,"ship",Ye(i.waveMin,i.waveNumber)),i.numEnemies>50&&t(4096,6144,i,"ship",Ye(i.waveMin,i.waveNumber)),i.numEnemies++,i.waveTimer.start();else if(i.numEnemies<=0){i.waveNumber=1,i.waveMin=1,i.ghostNumber=1;for(let e=0;e<5;e++)t(0,2048,i,"ship",1)}}else i.waveTimer.start()}}function a(e){let t=e.select(H);x.bind(this)(t,(t=>{let s=t.get(H);for(let t of s.tiles){let r=e.get(t.id);if(t.timer.isComplete()){let e=r.get(b);s.incTile(t),e.spriteName=s.getSpriteName(t),s.resetTileTimer(t)}}}))}function n(e){let t=e.select(b,A);x.bind(this)(t,(e=>{let t=e.get(b),s=e.get(A);t.highlighted=!s.sprTimer.isComplete()}))}function l(e){let t=e.select(b,j);x.bind(this)(t,(e=>{let t=e.get(b),s=e.get(j);s.sprTimer.isComplete()&&(s.sprTimer.start(),s.i=(s.i+1)%s.sprites.length,t.spriteName=s.sprites[s.i])}))}function o(e){let t=e.select(O,T);x.bind(this)(t,(t=>{let s=t.get(T),r=me(e).get(F);if(!y(e)||r.gameOver)return;let i=me(e).get(T);s.turnTowards([i.x,i.y]),s.acc=!0}))}function h(e){let t=e.select(z,R,T);x.bind(this)(t,(e=>{let t=e.get(z),s=e.get(T);t.x=s.x-t.w/2,t.y=s.y-t.h/2;let r=-32;t.x<r&&(t.x=r),t.x+t.w>4064&&(t.x=4064-t.w),t.y<r&&(t.y=r),t.y+t.h>4064&&(t.y=4064-t.h),t.x=Math.floor(t.x),t.y=Math.round(t.y),He.camera=t}))}function c(e){let t=e.select(T,_);x.bind(this)(t,(t=>{let s=t.get(_),{x:r,y:i}=t.get(T);if(s.hp<=0)if(s.hp=0,pe(t)){let t=me(e),s=t.get(F);t.get(b).highlighted=!0;let r=xe(e).get(I);r.endTimer.isComplete()&&!s.gameOver&&(Xe("end"),s.gameOver=!0,r.endTimer.start(),r.endTimer.onCompletion().then((()=>{Pe(s.score),ve(e)}))),r.endTimer.update()}else if((e=>e.id===ue)(t)){ke(t),Se(e,r,i),Xe("baseExpl");let s=me(e).get(F),a=[...s.usedCoords],n=a.findIndex((e=>e[0]===r&&e[1]===i));n>-1&&a.splice(n,1),s.score++;let[l,o]=a[Ye(0,a.length-1)];be(e,l,o,2*s.score),xe(e).get(I).setText("A new Heart has spawned!"),me(e).get(F).crates+=5}else t.has(R)?(Xe("sink"),ke(t),Se(e,r,i),((e,t,s)=>{let r=new T(t,s),i=e.create();i.add(new b({scale:2,z:9}),r,new M,new j(["spr_8","spr_9"],400),new C(We(t,s,16)),new S({duration:75e3,scale:{start:2,end:2}})),He.addRenderObject(i)})(e,r,i)):t.has(U)&&(Xe("sink"),ke(t),Se(e,r,i))}))}function d(e){let t=e.select(T,D,N);x.bind(this)(t,(e=>{let t=e.get(D),s=e.get(N),r=e.get(T);t.enabled&&!t.onCooldown?(t.gauge.fill(.12),s.c="#A1EF79",r.accRate=.7,t.gauge.isFull()&&(t.onCooldown=!0)):(s.resetColor(),r.resetAcc(),t.onCooldown&&0===t.gauge.getPct()&&(t.onCooldown=!1)),t.gauge.update()}))}function g(e){let t=e.select(T,U,b);x.bind(this)(t,(t=>{let s=t.get(U),r=t.get(T),i=t.get(b),a=me(e).get(T),n=Ve(a.x,a.y,r.x,r.y);n>2e3&&s.timer.start();let l=s.timer.getPctComplete(),o=5*Math.sin(f(l,0,1,0,2*Math.PI));r.y+=o,s.timer.isComplete()&&(s.timer.start(),n<1e3&&Xe("ghost")),i.flipped=r.vx>0}))}function p(e){let t=e.select(T);x.bind(this)(t,(e=>{let t=e.get(T);if(t.acc||t.accRev){let[e,s]=qe(t.angle,t.accRate);t.ax=e,t.ay=s,t.accRev&&(t.ax*=-.5,t.ay*=-.5)}let s=$.fm,r=t.ay/t.mass*s;t.vx+=t.ax/t.mass*s,t.vy+=r,t.dragOn&&function(e){let t=$.fm,s=e.coeff,r=0,i=0;r=s*e.vx/2,i=s*e.vy/2,e.vx-=r/e.mass*t,e.vy-=i/e.mass*t}(t),t.x+=t.vx*s,t.y+=t.vy*s,t.ax=0,t.ay=0,t.acc=!1}))}function m(e){let t=document.getElementById("canvasDiv");this.update=()=>{t.style.filter=me(e).get(F).gameOver?"grayscale(1)":""}}function u(e){function t(e,t,s,r,i,a){$.drawRect(e,t,s,20,"#000"),$.drawRect(e,t,s*r,20,a),$.drawText(i,e+4,t+11,{align:"left"})}let s=$.getCtx(),r=s.createLinearGradient(0,0,0,150);r.addColorStop(0,"rgba(0,0,0,0.25)"),r.addColorStop(.8,"rgba(0,0,0,0)");let i=s.createLinearGradient(0,$.height-100,0,$.height);i.addColorStop(1,"rgba(0,0,0,0.25)"),i.addColorStop(0,"rgba(0,0,0,0)");let a=new Me(500);a.start();let n="spr_21",l="#aaa";this.update=()=>{let s=xe(e).get(I);s.textTimer.isComplete()||$.drawText(s.text,$.width/2,150,{size:32}),s.endTimer.isComplete()||$.drawText("Game over.",$.width/2,$.height/2,{size:48}),function(s){let a=me(e),n=a.get(F),l=a.get(D),o=a.get(_),h=we(e).get(_),c=o.hp/o.maxHp,d=h.hp/h.maxHp,g=1-l.gauge.getPct(),p=$.height-40,m=$.width-256-20;$.drawRect(0,$.height-100,300,100,i),t(20,p,256,c,"Player HP","#42CAFD"),t(20,p-32,224,g,"Boost",l.onCooldown?"#243F72":"#827094"),$.drawRect($.width-300,$.height-100,300,100,i),t(m,p,256,d,"Heart HP","#F47E1B"),$.drawText("Hearts Destroyed: "+n.score,m,p-16,{align:"left"});let u=n.crates;$.drawRect(0,0,260,150,r),$.drawSprite("spr_8_f",64,34,0,4),$.drawText("Supplies: "+u,100,32,{align:"left"});let w=[u>=s.costUpgrade?"#FBFCAA":"#8D87A2",u>=s.costNew?"#FBFCAA":"#8D87A2",u>=s.costHeal?"#FBFCAA":"#8D87A2"];s.textFlashI>-1&&(w[s.textFlashI]=s.textFlashColor),s.textFlashTimer.isComplete()&&(s.textFlashI=-1),$.drawText(`Press 1: Upgrade Turret (${s.costUpgrade})`,20,64,{color:w[0],align:"left"}),$.drawText(`Press 2: New Turret (${s.costNew})`,20,96,{color:w[1],align:"left"}),$.drawText(`Press 3: Repair (${s.costHeal})`,20,128,{color:w[2],align:"left"})}(s),(()=>{let t=me(e).get(F);if(!t.gameStarted){if($.drawRect(0,0,$.width,$.height,"#000"),a.isComplete()&&(n="spr_21"===n?"spr_21_f":"spr_21",l="#aaa"===l?"#fff":"#aaa",a.start()),t.firstScreenUiVisible)return $.drawText("Your objective: ",$.width/2,100,{size:24,color:"#aaa"}),$.drawText("Destroy the Hearts of the Gods",$.width/2,132,{size:24,color:"#fff"}),$.drawSprite(n,$.width/2,220,0,6),$.drawText("The underworld navy will try to stop you.",$.width/2,320,{size:24,color:"#fff"}),$.drawSprite("spr_3",$.width/2,380,0,4),$.drawText("Pick up supplies to upgrade your vessel.",$.width/2,448,{size:24,color:"#fff"}),$.drawSprite("spr_8",$.width/2,512,0,6),$.drawText("Left/Right Arrows: Turn Vessel   Up/Down Arrows: Accelerate Vessel",$.width/2,564,{size:24,color:"#aaa"}),$.drawText("Shift: Boost",$.width/2,600,{size:24,color:"#aaa"}),void $.drawText("Press any button.",$.width/2,$.height-100,{size:32,color:l});$.drawText("HEART OF THE GODS",$.width/2,140,{size:52,color:"#00635C",strokeColor:""}),$.drawText("HEART OF THE GODS",$.width/2,144,{size:52,color:"#8E478C",strokeColor:""}),$.drawText("HEART OF THE GODS",$.width/2,148,{size:52,color:"#00635C",strokeColor:""}),$.drawSprite(n,$.width/2,$.height/2,0,6),void 0!==Oe&&$.drawText("Hearts Destroyed on Previous Mission: "+Oe,$.width/2,$.height-300,{size:16,color:"#FFF"}),$.drawText("Welcome to the Underworld.",$.width/2,$.height-200,{size:16,color:"#00A383"}),$.drawText("Press any button.",$.width/2,$.height-100,{size:32,color:l})}})()}}function w(e){let t=e.select(R,T,_),s=e.select(U,T,_),r=e.select(E,T,_),i=(i,a,n)=>{let l=1/0,o=[],h=[];t.iterate((e=>{let t=e.get(R),{angle:s,x:r,y:l}=e.get(T);if(e.id!==n.id)for(let{offset:e}of t.hitCircles){let[t,n]=qe(s,e),o=r+t,c=l+n,d=Ve(o,c,i,a);h.push([o,c,d])}})),r.iterate((e=>{let{x:t,y:s}=e.get(T),r=Ve(t,s,i,a);h.push([t,s,r])})),s.iterate((e=>{let{x:t,y:s}=e.get(T),r=Ve(t,s,i,a);h.push([t,s,r])}));let c=we(e).get(T),{x:d,y:g}=c,p=Ve(d,g,i,a);h.push([d,g,p]);for(let e=0;e<h.length;e++){let t=h[e];t[2]<l&&(o=t,l=t[2])}return o.length?o:null},a=(t,s)=>{let r=me(e).get(T),i=Ve(t,s,r.x,r.y);return[r.x,r.y,i]},n=(t,s,r)=>{let[i,a,n]=r,{physics:l,range:o,timer:h,sprTimer:c,dmg:d}=t;if(n<o){if(l.lookAt([i,a]),h.isComplete()){h.start(),c.start();let r=qe(l.angle,16);Xe("shoot1"),((e,t,{x:s,y:r,angle:i,spd:a,dmg:n,ms:l,col:o,sz:h})=>{let c=e.create(),d=new T(s,r);d.dragOn=!1,d.angle=i;let[g,p]=qe(i,a);d.setV(g,p),c.add(new P(n,t),new b({circle:{r:h,color:o},z:11}),new S({duration:l}),d,new C(We(s,r,5))),He.addRenderObject(c)})(e,s,{col:t.prjColor,x:l.x+r[0],y:l.y+r[1],angle:l.angle,spd:t.prjSpd+Math.sqrt(l.vx**2+l.vy**2),dmg:d,ms:4e3,sz:t.prjSz})}return!0}},l=t=>{let s=t.get(R),{angle:r,x:l,y:o}=t.get(T),h=t.get(_),c=s.getTurretPositions(r);for(let s of c){let r,{offset:[c,d],physics:g}=s,p=g.x=l+c,m=g.y=o+d,u="player";if(pe(t)?r=i(p,m,t):(u="enemy",r=a(p,m)),!r||h.hp<=0)continue;let w=me(e).get(F);y(e)&&!w.gameOver&&n(s,u,r)}};this.update=()=>{t.iterate(l)}}function f(e,t,s,r,i){return r+(e-t)*(i-r)/(s-t)}function x(e,t){return Object.assign(this,{update:"function"==typeof e?e:()=>e.iterate(t)})}function y(e){return me(e).get(F).gameStarted}class T{vx=0;vy=0;ax=0;ay=0;mass=1;angle=0;angleRate=2;acc=!1;accRev=!1;accRate;coeff=.1;dragOn=!0;constructor(e,t){this.x=e,this.y=t,this.resetAcc()}resetAcc(){this.accRate=.3}setV(e,t){this.vx=e,this.vy=t}setAngle(e){e<0?e+=360:e>360&&(e-=360),this.angle=e}lookAt(e){this.setAngle(Ke([this.x,this.y],e))}turnTowards(e){let t=Ke([this.x,this.y],e);if(this.turn(this.angle<=t?Math.abs(this.angle-t)<180?"r":"l":Math.abs(this.angle-t)<180?"l":"r"),this.angle===t)return!0}turn(e){let t=this.angleRate*$.fm;"l"==e?this.setAngle(this.angle-t):"r"==e&&this.setAngle(this.angle+t)}}class C{circle;constructor(e){this.circle=e}}class v{constructor(e){this.rect=e}}class b{spriteName;flipped=!1;highlighted=!1;opacity=1;useHeading=!0;z;scale;circle;rectangle;ship;constructor(e){let{spriteName:t,circle:s,rectangle:r,z:i,scale:a,ship:n,useHeading:l}=e??{};this.spriteName=t??"",this.circle=s,this.rectangle=r,this.z=i??0,this.scale=a??1,this.ship=n,this.useHeading=l??!1}}class S{timer;opacity={start:1,end:1};scale={start:1,end:1};cb=()=>{};constructor({duration:e,scale:t,opacity:s,cb:r}){this.timer=new Me(e),this.opacity=s??this.opacity,this.scale=t??this.scale,this.cb=r??(()=>{})}}class E{constructor({sprNum:e,ms:t,dmg:s,offset:r,range:i,prjColor:a,prjSpd:n,prjSz:l}){this.sprNum=e,this.timer=new Me(t),this.sprTimer=new Me(100),this.dmg=s,this.offset=r,this.physics=new T(0,0),this.range=i,this.level=1,this.prjColor=a,this.prjSpd=n,this.prjSz=l}}class R{hitCircles=[];turrets;spriteNumbs;spriteR;constructor(e,t,s=16){let r=e.length;this.spriteNumbs=e,this.turrets=t,this.spriteR=s,this.buildHitCircles(r)}buildHitCircles(e){this.hitCircles=[];let t=0;e>1&&(t=-this.spriteR*(e-1));for(let s=0;s<e;s++)this.hitCircles.push({r:16,offset:2*s*this.spriteR+t})}addTurret(){this.turrets.push(new E({sprNum:22,ms:1e3,dmg:1,offset:32,range:300,prjSpd:10,prjColor:de,prjSz:5}));let e=this.spriteNumbs;this.spriteNumbs=[...e.slice(0,-2),10,...e.slice(-2)],this.buildHitCircles(this.spriteNumbs.length)}upgradeTurret(){let e;for(let t of this.turrets)(!e||t.level<e.level)&&(e=t);return!!(e&&e.level<4)&&(e.level++,e.sprNum+=2,e.dmg++,e.range+=10,e.prjSz++,e.prjSpd++,e.timer.start(e.timer.duration-100),!0)}getHitCirclePositions(e){let t=[];for(let s in this.hitCircles)t.push({r:this.hitCircles[s].r,offset:qe(e,this.hitCircles[s].offset),spr:"spr_"+this.spriteNumbs[s]});return t}getTurretPositions(e){let t=[];for(let s in this.turrets){let r=this.turrets[s];t.push({...r,offset:qe(e,this.hitCircles[s].offset),spr:"spr_"+(r.sprNum+(r.sprTimer.isComplete()?0:1))})}return t}}class F{keys={};score=0;crates=0;gameOver=!1;gameStarted=!1;firstScreenUiVisible=!1;usedCoords=[];setKeyDown(e){this.keys[e]=!0}setKeyUp(e){this.keys[e]=!1}}class N{spawnTimer=new Me(100);c;constructor(e){this.r=e,this.resetColor()}resetColor(){this.c="#92F4FF"}}class A{constructor(){this.sprTimer=new Me(100),this.sprTimer.timestampStart=0}}class j{constructor(e,t){this.sprTimer=new Me(t),this.sprTimer.timestampStart=-9999,this.i=0,this.sprites=e}}class O{}class H{tiles=[];scale=4;width=64;height=64;constructor(e){for(let t=0;t<this.height;t++)for(let s=0;s<this.width;s++){let r={id:"",spr:0,timer:new Me(Ye(100,2e4))};this.tiles.push(r);let i=Ee(e,s*this.scale*16,t*this.scale*16,this.getSpriteName(r),this.scale);r.id=i}}incTile(e){e.spr=(e.spr+1)%4}getSpriteName(e){return"spr_"+(e.spr+4)}resetTileTimer(e){e.timer.start(0===e.spr?Ye(5e3,2e4):150)}}class z{x=0;y=0;w=$.SCREEN_WIDTH;h=$.SCREEN_HEIGHT}class P{constructor(e,t){this.dmg=e,this.allegiance=t}}class _{constructor(e){this.hp=this.maxHp=e}}class k{waveNumber=0;waveMin=1;numEnemies=0;numEnemies2=0;numEnemies3=0;numEnemies4=0;waveTimer=new Me(4500);ghostNumber=1;ghostTimer=new Me(6e4);constructor(){this.waveTimer.timestampStart=-this.waveTimer.duration}}class I{costUpgrade=5;costNew=10;costHeal=5;textTimer=new Me(3e3);endTimer=new Me(4e3);textFlashTimer=new Me(250);textFlashI=-1;textFlashColor="";constructor(){this.endTimer.timestampStart=-9999,this.text=""}setText(e){this.text=e,this.textTimer.start()}setTextFlash(e,t){this.textFlashTimer.start(),this.textFlashI=e,this.textFlashColor=t}}class M{}class D{constructor(){this.gauge=new De(10,.1),this.onCooldown=!1,this.enabled=!1}}class U{constructor(){this.timer=new Me(3e3),this.timer.start(),this.hitTimer=new Me(250),this.hitTimer.start()}}let B,G={},L={},W={WHITE:"#F8F8F8",BLACK:"#111",GREY:"#8D87A2",RED:"#E1534A",GREEN:"#71AA34",LIGHTGREEN:"#FBFCAA"},V={font:"Arial",color:"#F8F8F8",size:18,align:"center",strokeColor:"#111"},$=new class{width=0;height=0;fm=1;colors=W;SCREEN_HEIGHT=768;SCREEN_WIDTH=1024.5;enabled=!0;async init(){let[e]=this.createCanvas("canv",this.width,this.height);B=e,this.handleResize(),document.getElementById("canvasDiv")?.appendChild(B);let t=await new Promise((e=>{let t=new Image;t.onload=()=>{G.sprites=t,e(t)},t.src="res/sprites.png"})),s=t.width,r=16,i=0;for(let e=0;e<s/r;e++)for(let a=0;a<s/r;a++){let s=this.createSprite(t,a*r,e*r,r,r);L["spr_"+i]=s;let n=L["spr_"+i+"_f"]=this.createFlippedSprite(s);L["spr_"+i+"_h"]=this.createHitSprite(s),L["spr_"+i+"_f_h"]=this.createHitSprite(n),i++}}handleResize(){B&&(B.width=this.width=this.SCREEN_WIDTH,B.height=this.height=this.SCREEN_HEIGHT,this.getCtx().imageSmoothingEnabled=!1)}getCtx(){return B.getContext("2d")}setOpacity(e){this.getCtx().globalAlpha=e}createCanvas=(e,t,s)=>{let r=document.createElement("canvas");r.id=e,r.width=t,r.height=s;let i=r.getContext("2d");return i.imageSmoothingEnabled=!1,[r,i]};createSprite(e,t,s,r,i){let[a,n]=this.createCanvas("",16,16);return n.drawImage(e,t,s,r,i,0,0,r,i),[a,0,0,r,i]}createFlippedSprite(e){let[t,,,s,r]=e,[i,a]=this.createCanvas("",s,r);return a.translate(s,0),a.scale(-1,1),a.drawImage(t,0,0),[i,0,0,s,r]}createHitSprite(e){let[t,,,s,r]=e,[i,a]=this.createCanvas("",s,r);return a.filter="invert(1)",a.drawImage(t,0,0),[i,0,0,s,r]}clear(e){(e=e??this.getCtx()).clearRect(0,0,e.canvas.width,e.canvas.height)}drawSprite(e,t,s,r,i,a){if(!this.enabled)return;i=i||1,(a=a??this.getCtx()).save();let n=L[e];r=r||0;let[l,o,h,c,d]=n,g=c*i,p=d*i;a.translate(t-=g/2,s-=g/2),a.translate(g/2,p/2),a.rotate(r*Math.PI/180),a.drawImage(l,o,h,c,d,t=-g/2,s=-p/2,c*i,d*i),a.restore()}drawRect(e,t,s,r,i,a,n){n=n??this.getCtx(),a&&(s-=n.lineWidth/2,r-=n.lineWidth/2),n[a?"strokeStyle":"fillStyle"]=i,n[a?"strokeRect":"fillRect"](e,t,s,r)}drawCircle(e,t,s,r,i,a){(a=a??this.getCtx()).beginPath(),a.arc(e,t,s,0-Math.PI/2,2*Math.PI*(i??1)-Math.PI/2),a.fillStyle=r,a.fill()}drawLine(e,t,s,r,i,a,n){a=a??1,(n=n??this.getCtx()).lineWidth=a,n.strokeStyle=i,n.beginPath(),n.moveTo(e,t),n.lineTo(s,r),n.stroke()}drawText(e,t,s,r,i){let{font:a,size:n,color:l,align:o,strokeColor:h}={...V,...r??{}};(i=i??this.getCtx()).font=`${n}px ${a}`,i.textAlign=o,i.textBaseline="middle",h&&(i.strokeStyle=h,i.lineWidth=4,i.strokeText(e,t,s)),i.fillStyle=l,i.fillText(e,t,s)}},K=[],q=[],Y={},J="_sign",Q="_mask";"undefined"!=typeof Symbol&&(J=Symbol(J),Q=Symbol(Q));let X=(e,t)=>{let s=t[e];if(!s)throw Error("The component is not registered");return s},Z=X.bind(null,J),ee=X.bind(null,Q),te=e=>{e.id&&K.forEach((t=>t.match(e)))},se=1,re={};class ie{constructor(e){this.id=e||(se++).toString(36),this.components=Object.assign({},re),this.mask=0}add(...e){e.forEach((e=>{this.components[Z(e.constructor)]=e,this.mask|=ee(e.constructor)})),te(this)}remove(...e){e.forEach((e=>{let t=Z(e),s=this.components[t];s&&(s.destructor&&s.destructor(),delete this.components[t],this.mask&=~ee(e))})),te(this)}has(e){return Z(e)in this.components}get(e){return this.components[e[J]]}eject(){var e;e=this,K.forEach((t=>t.remove(e))),delete Y[e.id],e.id=0}}class ae{constructor(e,t){this.entity=e,this.prev=null,this.next=t}}class ne{constructor(e){this.mask=e,this.map={},this.list=null,this.length=0;for(let e in Y)Object.prototype.hasOwnProperty.call(Y,e)&&this.match(Y[e])}iterate(e){let t=this.list;for(;t;)e(t.entity),t=t.next}match(e){(this.mask&e.mask)===this.mask?this.add(e):this.remove(e)}add(e){if(this.map[e.id])return;let t=new ae(e,this.list);this.list&&(this.list.prev=t),this.list=t,this.map[e.id]=t,this.length++}remove(e){let t=this.map[e.id];t&&(t.prev?t.prev.next=t.next:this.list=t.next,t.next&&(t.next.prev=t.prev),delete this.map[e.id],this.length--)}}let le=0,oe=performance||Date,he=oe.now.bind(oe),ce={register(...e){e.forEach((e=>{let t=le.toString(36);re[t]=null,e[J]=t,e[Q]=1<<le,le++}))},process(...e){e.forEach((e=>q.push(e)))},create(e){let t=new ie(e);if(!Y[t.id])return Y[t.id]=t,t},get:e=>Y[e],select(...e){let t=0;e.forEach((e=>{t|=ee(e)}));for(let e=0;e<K.length;e++)if(K[e].mask===t)return K[e];let s=new ne(t);return K.push(s),s},update(e){let t={};return q.forEach((s=>{let r=he();s.update(e),t[s.constructor.name]=he()-r})),t},reset(){for(let e in Y)Y[e].eject()}},de="#42CAFD",ge="",pe=e=>e.id===ge,me=e=>e.get(ge),ue="",we=e=>e.get(ue),fe="",xe=e=>e.get(fe),ye="",Te=(e,t,s,r)=>{for(let[i,a]of r)if(Ve(e,t,i,a)<s)return!0;return!1},Ce=(e,t,s,r)=>{let i,a,n=0;do{let s=Ye(e,t),r=Ye(0,270)+180+45-360,[l,o]=qe(r,s);i=2048+l,a=2048+o,n++}while(n<10&&Te(i,a,s,r));if(n>=10)return[0,0];let l=[i,a];return r.push(l),l},ve=e=>{e.reset(),He.clear(),function(e){let t=new F,s=new R([2,1,0],[new E({sprNum:22,ms:1e3,dmg:1,offset:32,range:300,prjSpd:15,prjColor:de,prjSz:5})]),r=new T(2048,3072);r.angleRate=4;let i=new b({ship:s,scale:2,z:10}),a=e.create();a.add(t,s,i,r,new N(48),new z,new A,new _(50),new D),ge=a.id,He.addRenderObject(a)}(e),Re(e),Ae(e),je(e);let t=me(e).get(F).usedCoords;for(let s=0;s<35;s++){let[s,r]=Ce(0,2e3,192,t);Ne(e,s,r)}let[s,r]=t[Ye(0,t.length-1)];be(e,s,r,0)},be=(e,t,s,r)=>{let i=e.create();i.add(new b({scale:6,z:3}),new C(We(t,s,44)),new j(["spr_21","spr_21_f"],500),new T(t,s),new A,new _(10+r)),ue=i.id,He.addRenderObject(i)},Se=(e,t,s)=>{let r=new T(t,s),i=e.create();i.add(new b({circle:{r:10,color:"#A05B53"},z:9}),r,new S({duration:1e3,opacity:{start:1,end:0},scale:{start:1,end:4}})),He.addRenderObject(i)},Ee=(e,t,s,r,i)=>{let a=new T(t,s),n=e.create();return n.add(new b({spriteName:r,scale:i,z:0}),a),He.addRenderObject(n),n.id},Re=e=>{let t=e.create();t.add(new H(e)),He.addRenderObject(t)},Fe=(e,t,s,r,i,a)=>{let n=e.create();if(n.add(new b({spriteName:"spr_"+r,scale:i,z:2}),new T(t,s)),a){let e=128;n.add(new v(Le(t-e/2,s-e/2,e,e)))}He.addRenderObject(n)},Ne=(e,t,s)=>{let r=10;Fe(e,t,s,15,4,!0);for(let i=-1;i<=1;i++)for(let a=-1;a<=1;a++)r++,0===i&&0===a||Fe(e,t+64*a,s+64*i,r,4)},Ae=e=>{let t=e.create();t.add(new I),fe=t.id},je=e=>{let t=e.create();t.add(new k),ye=t.id};window.addEventListener("load",(async()=>{await $.init(),window.addEventListener("resize",(()=>{$.handleResize()})),window.draw=$,ce.register(T,b,C,v,S,R,E,A,j,F,N,O,H,z,P,_,I,k,M,D,U),ce.process(...ze(ce)),ve(ce),(()=>{let e=performance.now(),t=new u(ce),s=f(22,16,30,1,2),r=()=>{He.drawRenderObjects(ce),t.update(),requestAnimationFrame(r)};setInterval((()=>{let t=performance.now(),r=t-e;e=t,r>4&&(r=4);let i=r;r-=i,$.fm=i*s/10,$.enabled=r<=0,(e=>{$.clear(),ce.update(e/1e3)})(i)}),22),r()})()}));let Oe,He=new class{renderObjects=[];camera;addRenderObject(e){e.get(b)&&e.get(T)&&this.renderObjects.push({id:e.id,ent:e})}removeRenderObject(e){let t=this.renderObjects.findIndex((t=>t.id===e.id));t>-1&&this.renderObjects.splice(t,1)}clear(){this.renderObjects=[]}drawEntity=e=>{let{x:t,y:s,angle:r}=e.get(T),{spriteName:i,circle:a,rectangle:n,opacity:l,scale:o,flipped:h,highlighted:c,ship:d,useHeading:g}=e.get(b),p="";if(h&&(p+="_f"),c&&(p+="_h"),$.setOpacity(l),i&&$.drawSprite(i+p,t,s,g?r:0,o),a){let{r:e,color:r}=a;$.drawCircle(t,s,e*o,r)}if(n){let{w:e,h:r,color:i}=n;$.drawRect(t,s,e*o,r*o,i)}if(d){let e=d.getHitCirclePositions(r);for(let{offset:[i,a],spr:n}of e)$.drawSprite(n+p,t+i,s+a,r,o);let i=d.getTurretPositions(r);for(let{spr:e,physics:t}of i)$.drawSprite(e,t.x,t.y,t.angle,o)}$.setOpacity(1)};sortRenderObjects(e){if(e.length<2)return;let t=!1;do{t=!1;for(let s=0;s<e.length-1;s++){let r=e[s],i=e[s+1],a=r.ent.get(b),n=i.ent.get(b);a.z>n.z&&(t=!0,e[s]=i,e[s+1]=r)}}while(t)}drawRenderObjects(e){if(this.sortRenderObjects(this.renderObjects),!this.camera)return;let{x:t,y:s,w:r,h:i}=this.camera,a=$.getCtx();a.save(),a.translate(-t,-s);for(let e=0;e<this.renderObjects.length;e++){let{ent:a}=this.renderObjects[e],{x:n,y:l}=a.get(T);Ve(t+r/2,s+i/2,n,l)<$.SCREEN_WIDTH/2+160&&this.drawEntity(a)}let{x:n,y:l}=we(e).get(T),{x:o,y:h}=me(e).get(T),c=Ke([o,h],[n,l]),[d,g]=qe(c,96),[p,m]=qe(c,64);$.drawCircle(o+d,h+g,2,"#FFF"),$.drawLine(o+p,h+m,o+d,h+g,"#FFF"),a.restore()}},ze=u=>[new t(u),new i(u),new o(u),new g(u),new d(u),new r(u),new n(u),new l(u),new a(u),new p(u),new w(u),new h(u),new m(u),new e(u),new s(u),new c(u)],Pe=e=>{Oe=e},_e=()=>window.performance.now(),ke=e=>{He.removeRenderObject(e),e.eject()},Ie=[];class Me{constructor(e){this.timestampStart=_e(),this.timestampPause=0,this.duration=e,this.paused=!1,this.awaits=[],Ie.push(this)}start(e){this.paused&&(this.timestampPause=_e(),this.unpause()),this.timestampStart=_e(),this.duration=e??this.duration}pause(){this.paused||(this.paused=!0,this.timestampPause=_e())}unpause(){this.paused&&(this.paused=!1,this.updateStart(_e()-this.timestampPause))}updateStart(e){this.timestampStart+=e}update(){this.isComplete()&&(this.awaits.forEach((e=>e())),this.awaits=[])}isComplete(){return this.getPctComplete()>=1}onCompletion(){return new Promise((e=>{this.isComplete()||this.awaits.push(e)}))}getPctComplete(){let e=_e();this.paused&&(e-=e-this.timestampPause);let t=e-this.timestampStart;return t>this.duration?t=this.duration:t<0&&(t=-1),Math.min(1,t/this.duration)}}class De{constructor(e,t){this.max=e,this.current=0,this.decayRate=t}fill(e){this.current+=e,this.current>this.max&&(this.current=this.max)}empty(){this.current=0}isFull(){return this.current>=this.max}getPct(){return this.current/this.max}update(){this.current-=this.decayRate*$.fm,this.current<0&&(this.current=0)}}let Ue,Be,Ge,Le=(e,t,s,r)=>({x:e,y:t,w:s,h:r}),We=(e,t,s)=>({x:e,y:t,r:s}),Ve=(e,t,s,r)=>{let i=s-e,a=r-t;return Math.sqrt(i*i+a*a)},$e=(e,t)=>{let[s,r,i]=e,[a,n,l]=t;return i=i||1,l=l||1,Ve(s,r,a,n)<=i+l},Ke=(e,t)=>{let[s,r]=e,[i,a]=t,n=a-r,l=Ve(s,r,i,a),o=0;return o=a>=r&&i>=s?180*Math.asin(n/l)/Math.PI+90:a>=r&&i<s?180*Math.asin(n/-l)/Math.PI-90:a<r&&i>s?180*Math.asin(n/l)/Math.PI+90:180*Math.asin(-n/l)/Math.PI-90,o>=360&&(o=360-o),o<0&&(o=360+o),o},qe=(e,t)=>{t=t??1;let s=e*Math.PI/180;return[Math.sin(s)*t,-Math.cos(s)*t]},Ye=(e,t)=>Math.floor(f(Math.random(),0,1,e,t+1)),Je={start:[,,253,.01,.02,.03,3,1.18,,-76,-2,,,,208,.1,,,.17,.01],end:[,,0,.25,.12,.23,3,.46,30,,-249,.05,.26,.9,,.2,,.97,.16,.02],invalid:[1.04,0,254,.01,.03,.13,1,.17,,.1,,,,.8,-61,.6,,.86,.02],col:[,,92,.02,.14,.01,1,.31,1.2,1.5,,,.11,,,,,,.08],upgrade:[1.21,,262,.11,.02,0,,2.4,,,221,.01,.16,,322,,.05,,.11],create:[,,104,,.06,.23,3,.32,,-71,-309,.01,,,20,,,.69,.17],heal:[1.1,,261,.18,.03,0,,1.63,-87,,,,.16,.2,-204,,.01,,.07],sink:[1.73,,187,.11,.02,.13,2,1.09,-97,,2,,,,11,.4,.08,.89,.04],baseExpl:[2.72,,749,.01,.29,.41,2,1.83,,.7,,,.14,.2,,.7,.17,.45,.02],shoot1:[.5,,424,.02,.01,.17,4,.16,-.7,,,,,2,.1,.2,,.62,.02,.21],exh:[.2,1,100,,.02,0,4,0,,36,,,,,8.4,-1,.13,,.15],exh2:[.4,1,100,,.02,0,4,0,,36,,,,,8.4,-1.4,.13,0,.15],hit1:[1.11,,325,.02,.1,.14,3,1.3,,-1.6,,,.05,1.3,-39,.1,,.88,.01,.24],hit2:[,,245,.01,,.16,4,2.46,2.5,,,,,1.7,,,,.46,.02],crate:[,,1727,.02,.01,.01,3,.33,,,108,.14,,,,.2],ghost:[2.18,,1258,.01,.08,.12,2,1.19,-.3,-8.5,-437,.01,.09,,,,.09,.57,.01,.17]},Qe=1,Xe=e=>{let t=Je[e];if(!t)throw Error("no sound: "+e);Ze(.2*Qe),et(...t)};document.getElementById("volume").addEventListener("change",(e=>{Qe=+e.target.value/100,Xe("coll")})),Be=.3;let Ze=e=>{Be=e};Ue=(e=1,t=.05,s=220,r=0,i=0,a=.1,n=0,l=1,o=0,h=0,c=0,d=0,g=0,p=0,m=0,u=0,w=0,f=1,x=0,y=0)=>{let T,C,v=Math,b=44100,S=2*v.PI,E=o*=500*S/b/b,R=s*=(1-t+2*t*v.random(t=[]))*S/b,F=0,N=0,A=0,j=1,O=0,H=0,z=0;for(h*=500*S/b**3,m*=S/b,c*=S/b,d*=b,g=b*g|0,C=(r=b*r+9)+(x*=b)+(i*=b)+(a*=b)+(w*=b)|0;A<C;t[A++]=z)++H%(100*u|0)||(z=n?1<n?2<n?3<n?v.sin((F%S)**3):v.max(v.min(v.tan(F),1),-1):1-(2*F/S%2+2)%2:1-4*v.abs(v.round(F/S)-F/S):v.sin(F),z=(g?1-y+y*v.sin(S*A/g):1)*(0<z?1:-1)*v.abs(z)**l*e*Be*(A<r?A/r:A<r+x?1-(A-r)/x*(1-f):A<r+x+i?f:A<C-w?(C-A-w)/a*f:0),z=w?z/2+(w>A?0:(A<C-w?1:(C-A)/w)*t[A-w|0]/2):z),T=(s+=o+=h)*v.cos(m*N++),F+=T-T*p*(1-1e9*(v.sin(A)+1)%2),j&&++j>d&&(s+=c,R+=c,j=0),!g||++O%g||(s=R,o=E,j=j||1);return(e=Ge.createBuffer(1,C,b)).getChannelData(0).set(t),(s=Ge.createBufferSource()).buffer=e,s.connect(Ge.destination),s.start(),s},Ge=new(window.AudioContext||webkitAudioContext);let et=Ue;